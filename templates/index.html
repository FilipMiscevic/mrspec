<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://www.google.com/jsapi"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <link
        href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"
        rel="stylesheet">

        <style type="text/css">
			#left {float:left}
			#right {float:left;      
                    }
        
			#sidebar {
			    overflow-y:auto;
				background-color: white;
				width: 545px;
				position: static;
				left: 700px;

			}

			#sidebar .patient {
				border: 1px solid #eee;
				padding: 10px;
				padding-bottom: 5px;
				margin-top: 10px;
			}

			#sidebar .title {
				font-weight:600;
				background-color: white;
				color: #909090;
				text-align: left;
				padding-left: 5px
			}

			#sidebar .content {
				text-align: left;
				padding-left: 15px;
				padding-bottom: 5px
			}

			#sidebar .listContainer{
} 

ul.justify { margin-left:-2.75em; } 


.expList ul, li {

    list-style: none;
    margin:0;
    padding:0;
    cursor: pointer;
    

}
.expList p {
    margin:0;
    display:block;
}
.expList p:hover {
    background-color:#121212;
}
.expList li {
    line-height:140%;
    text-indent:0px;
    background-position: 1px 8px;
    padding-left: 20px;
    background-repeat: no-repeat;
}
 
/* Collapsed state for list element */
.collapsed {
    background-image: url(../img/collapsed.png);
        background-position: 1px 8px;
    padding-left: 20px;
    background-repeat: no-repeat;
}
/* Expanded state for list element
/* NOTE: This class must be located UNDER the collapsed one */
.expanded {
    background-image: url(../img/expanded.png);
    background-position: 1px 8px;
    padding-left: 20px;
    background-repeat: no-repeat;
}

.blackout {
	background-color:#000;
	opacity:.2;
	filter:alpha(opacity=70);
	height:100%;
	width:100%;
	position:fixed;
	top:0;
	left:0;
	z-index:100;
	display:none;
	cursor:pointer;
	}
.msgbox {
	background-color:#ccc;
	border:1px solid #ccc;
	color:#000;
	width:30%;
	height:30%;
	position:fixed;
	top:20%;
	left:15%;
	border-radius:20px;
	padding:10px;
	z-index:101;
	display:none;
	margin-left: 20%;
	}
.closeBox {
	background-color:#CC0000;
	color:#FFFFFF;
	padding:8px;
	float:right;
	border-radius:3px;
	cursor:pointer;
	text-transform:uppercase;

	}

.optionBox {
	outline: 1px solid #B0B0B0;
	display:inline;
	padding-top:2px;
	padding-bottom: 2px;
}

.optionBox:hover {
   overflow:visible;
   }
        </style>
    </head>
    <body>
        <div id ='top_header' class="container">
            <div class="header">
                <h3 class="text-muted">MRSpec Database Query and Visualization</h3>
            </div>
            <hr />
            <div>
                <p>
                    <form>
                        <span title="Search for a tabPatientID.">IDs: <input type="text" size="2" name="ID"></span>
                        <span title="The age of the query. Used to set the center of the limit.">Age:
                        <div class ='optionBox'><input type="text" size="2" name="age" placeholder="Days"style="border:0px solid;"><img id='ageOpt' src="../img/new_window.png" style="padding-bottom:3px" /></div></span>
                        <span title="Gender of the query.">Gender:
                        <select id='gender' name='gender'>
                            <option value="">Both</option>
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select></span>
                        <span title="Field strength of the query."">Field Strength:
                        <select id='field' name='field'>
                            <option value="">Both</option>
                            <option value="3">3T</option>
                            <option value="1.5">1.5T</option>
                        </select></span>
                        <span title="Metabolite of the query.">Metabolites:
                        <div class ='optionBox'><input type="text" size="4" name="metabolites" style="border:0px solid"><img id='metOpt' src="../img/new_window.png" style="padding-bottom:3px" /></div></span>
                        <span title="Values of the query.">Values:
                        <input type="text" size="5" name="values"></span>
                        <span title="Keywords of the query. e.g. '%glioma'">Keywords:
                        <div class ='optionBox'><input type="text" size="4" name="keyword" style="border:0px solid"><img id='keyOpt' src="../img/new_window.png" style="padding-bottom:3px" /></div></span>
                        
                        <span title="Location of the query.">Location:
                        <select id='location' name='location'>
                            <option value="">Any</option>
                            <option value="BG">BG</option>
                            <option value="OCC_WM">OCC WM</option>
							<option value="FT_WM">FT WM</option>
							<option value="Cerebellum">CRBL</option>
                        </select></span>
                        <span title="Only include the X closest patients above and below the 'AGE'.">Limit:
                        <input type="text" size="2" name="limit"></span>
                        <span title="Lower limit of the X-axis range.">Lower X Limit:
                        <input type="text" size="2" name="lxlimit"></span>
                        <span title="Upper limit of the X-axis range.">Upper X Limit:
                        <input type="text" size="2" name="uxlimit"></span>
                        <span title="Select data that lies outside of a certain standard deviation threshold.">SD threshold:
                        <input type="text" size="2" name="sdThreshold"></span>
                        <span title="More options.">More options <img id='allOpt' src="../img/new_window.png" style="padding-bottom:3px" /></span>
                        <br>
                        <span title="Merge graphs.">Merge Graphs:
                        <input type="checkbox" id="merge" name="Merge Graphs"></span>
                        <span title="Log scale.">Log Scale:
                        <input type="checkbox" id="scale" name="scale" onclick="drawChart(window.my_config.results)"></span>
                        <span title="Trendline.">Trendline:
                        <span title="Overlay queries."><input type="checkbox" id="trendline" name="trendline" onclick="drawChart(window.my_config.results)">
                        Overlay queries:
                        <input
                        type="checkbox" id="overlay" name="overlay" onclick="document.getElementById('merge').disabled = true;"></span>

                    </form>
                <p>
                    <a href="javascript:void();" id="query" class='query'>submit
                    query</a> - <a href="javascript:void();" id='clear'>clear canvas</a> - <a href="javascript:void();" id="dump" onclick="exportToCsv()">export canvas to file</a> - <a href="javascript:void();" id="png_dump" onclick="exportChartsAsPng()"> export charts as .png</a>
                </p>
                </form>
            </div>
        </div>

		<div id = 'left'>
        <div id="charts"></div>
        </div>

		<div id='right'>
        <div id="sidebar" ></div>

		</div>


<div class="blackout">
</div>
<div id='ageWindow' class="msgbox">
<div class="closeBox">
Close</div>
<left>
<form action="#" method="post"><br />

<label>Years:<input type="text" size="4" id='years' name='years' onKeyUp="calculateAge()" value='0'></label><br>
<label>Months:<input type="text" size="4" id='months' name='months' onKeyUp="calculateAge()" value='0'></label><br>
<label>Weeks:<input type="text" size="4" id='weeks' name='weeks' onKeyUp="calculateAge()" value='0'></label><br>
<label>Days:<input type="text" size="4" id='days' name='days' onKeyUp="calculateAge()" value='0'></label>

</form>
</left>
</div>

<div class="blackout">
</div>
<div id='metWindow' class="msgbox">
<div class="closeBox">
Close</div>
<left>
<form action="#" method="post" onchange='updateMetabolites()'><br />

<label>Select all:<input type='checkbox' id='selAll' onclick='checkAll()'></label><br>
<label>AcAc:<input type='checkbox' id=AcAc name=AcAc class='met'></label>
<label>Acn:<input type='checkbox' id=Acn name=Acn class='met'></label>
<label>Ala:<input type='checkbox' id=Ala name=Ala class='met'></label>
<label>Asp:<input type='checkbox' id=Asp name=Asp class='met'></label>
<label>Cho:<input type='checkbox' id=Cho name=Cho class='met'></label>
<label>Cr:<input type='checkbox' id=Cr name=Cr class='met'></label>
<label>CrCH2:<input type='checkbox' id=CrCH2 name=CrCH2 class='met'></label>
<label>GABA:<input type='checkbox' id=GABA name=GABA class='met'></label>
<label>GPC:<input type='checkbox' id=GPC name=GPC class='met'></label>
<label>Glc:<input type='checkbox' id=Glc name=Glc class='met'></label>
<label>Gln:<input type='checkbox' id=Gln name=Gln class='met'></label>
<label>Glu:<input type='checkbox' id=Glu name=Glu class='met'></label>
<label>Glx:<input type='checkbox' id=Glx name=Glx class='met'></label>
<label>Gua:<input type='checkbox' id=Gua name=Gua class='met'></label>
<label>Ins:<input type='checkbox' id=Ins name=Ins class='met'></label>
<label>Lac:<input type='checkbox' id=Lac name=Lac class='met'></label>
<label>Lip09:<input type='checkbox' id=Lip09 name=Lip09 class='met'></label>
<label>Lip13a:<input type='checkbox' id=Lip13a name=Lip13a class='met'></label>
<label>Lip13b:<input type='checkbox' id=Lip13b name=Lip13b class='met'></label>
<label>Lip20:<input type='checkbox' id=Lip20 name=Lip20 class='met'></label>
<label>MM09:<input type='checkbox' id=MM09 name=MM09 class='met'></label>
<label>MM12:<input type='checkbox' id=MM12 name=MM12 class='met'></label>
<label>MM14:<input type='checkbox' id=MM14 name=MM14 class='met'></label>
<label>MM17:<input type='checkbox' id=MM17 name=MM17 class='met'></label>
<label>MM20:<input type='checkbox' id=MM20 name=MM20 class='met'></label>
<label>NAA:<input type='checkbox' id=NAA name=NAA class='met'></label>
<label>NAAG:<input type='checkbox' id=NAAG name=NAAG class='met'></label>
<label>PCh:<input type='checkbox' id=PCh name=PCh class='met'></label>
<label>PCr:<input type='checkbox' id=PCr name=PCr class='met'></label>
<label>Scyllo:<input type='checkbox' id=Scyllo name=Scyllo class='met'></label>
<label>Tau:<input type='checkbox' id=Tau name=Tau class='met'></label>
<label>tCho:<input type='checkbox' id=tCho name=tCho class='met'></label>
<label>tCr:<input type='checkbox' id=tCr name=tCr class='met'></label>
<label>tNAA:<input type='checkbox' id=tNAA name=tNAA class='met'></label>

</form>
</left>
</div>

<div class="blackout">
</div>
<div id='keyWindow' class="msgbox">
<div class="closeBox">
Close</div>
<left>
<form action="#" method="post"><br />

<label>Not currently implemented.
</label>

</form>
</left>
</div>

<div class="blackout">
</div>
<div id='allWindow' class="msgbox">
<div class="closeBox">
Close</div>
<left>
<form action="#" method="post"><br />

<label>Not currently implemented.
</label>

</form>
</left>
</div>
        <script type="text/javascript">

        function calculateAge(){
            var years = $('#years').val()
            var months = $('#months').val()
            var weeks = $('#weeks').val()
            var days = $('#days').val()

            var total = parseInt(days) + parseInt(weeks)*7 + parseInt(months)*30 + parseInt(years)*365

            $("input[name='age']").val(total)

        }

        var all_mets = ['CrCH2', 'AcAc', 'Acn', 'Ala', 'Asp', 'Cho', 'Cr', 'GABA', 'GPC', 'Glc',
        'Gln', 'Glu', 'Gua', 'Ins', 'Lac', 'Lip09', 'Lip13a', 'Lip13b', 'Lip20', 'MM09',
        'MM12', 'MM14', 'MM17', 'MM20', 'NAA', 'NAAG', 'PCh', 'PCr', 'Scyllo', 'Tau',
        'tCr', 'tNAA', 'tCho', 'Glx']

        function inputValid(){
            var num_list = /^[0-9.]+(,[0-9.]+)*$/i;
            var opt_num_list = /^([0-9]+(,[0-9]+)*)*$/i

             
            mets = $('input[name="metabolites"]').val().split(',')
            for (met in mets){
                console.log(mets[met])
                if ($.inArray(mets[met], all_mets) === -1){
                    alert('You entered\n\n' +$('input[name="metabolites"]').val()+ '\n\nPlease enter valid query metabolites, separated by dashes.')

                    return false
                }
            }

            if ($('input[name="values"]').val().search(num_list) < 0){
                alert('You entered\n\n' +$('input[name="values"]').val()+ '\n\nPlease enter metabolite values separated by dashes.')
                return false
            }

            if ($('input[name="ID"]').val().search(opt_num_list) < 0){
                alert('You entered\n\n' +$('input[name="ID"]').val()+ '\n\nPlease enter ID values separated by dashes.')
                return false
            }

            if ($('input[name="limit"]').val().search(/^[0-9]*$/) < 0){
                alert('Limit must be a number.')
                return false
            }

            if ($('input[name="age"]').val().search(/^[0-9]*$/) < 0){
                alert('Age must be a number.')
                return false
            }

            /*keywords: $('input[name="keyword"]').val(),
            key_exclude: $('input[name="key_exclude"]').val(),
            age: $('input[name="age"]').val(),
            location: $('#location option:selected').val(),
            merge: document.getElementById('merge').checked,
            ID: $('input[name="ID"]').val(),*/

            return true
        }

         function checkAll() {
             checkboxes = document.getElementsByClassName('met');

             for (i = 0; i < checkboxes.length; i++) {
                 if (document.getElementById('selAll').checked == true) {
                     checkboxes[i].checked = true
                 } else {
                    checkboxes[i].checked = false 
                 }
             }

             updateMetabolites()

         }

         function updateMetabolites() {
             checkboxes = document.getElementsByClassName('met');

             $('input[name="metabolites"]').val("")
             $('input[name="values"]').val("")

             for (i = 0; i < checkboxes.length; i++) {
                 if (checkboxes[i].checked == true) {
                     $('input[name="metabolites"]').val($('input[name="metabolites"]').val() + "," + checkboxes[i].name)
                     $('input[name="values"]').val($('input[name="values"]').val() + ",0")
                 }
             }
             $('input[name="metabolites"]').val($('input[name="metabolites"]').val().substring(1))
             $('input[name="values"]').val($('input[name="values"]').val().substring(1))
         }

        function exportToCsv(){
            for (result in window.my_config.results){
                data = new google.visualization.DataTable(window.my_config.results[result])
                csv = dataTableAndMetadataToCSV(data)
                downloadCSV(csv, result)
            }
        }

        function exportChartsAsPng(){
            for (chart in window.my_config.charts){
                downloadPNG(window.my_config.charts[chart].getImageURI(), chart)
            }
        }

        function downloadPNG (png_out, name) {

        var data = atob( png_out.substring( "data:image/png;base64,".length ) ),
        asArray = new Uint8Array(data.length);

        for( var i = 0, len = data.length; i < len; ++i ) {
            asArray[i] = data.charCodeAt(i);    
        }

            var blob = new Blob( [ asArray.buffer ], {type: "image/png"} );

            var url  = window.URL || window.webkitURL;
            var link = document.createElementNS("http://www.w3.org/1999/xhtml", "a");
            link.href = url.createObjectURL(blob);
            link.download = name + ".png"; 

            var event = document.createEvent("MouseEvents");
            event.initEvent("click", true, false);
            link.dispatchEvent(event); 
}

        //This is the function that closes the pop-up
function endBlackout(){
$(".blackout").css("display", "none");
$(".msgbox").css("display", "none");
}

//This is the function that starts the pop-up
function strtBlackout(id){
$("#"+id).css("display", "block");
$(".blackout").css("display", "block");
}

//Sets the buttons to trigger the blackout on clicks
$(document).ready(function(){
$("#ageOpt").click(function() {strtBlackout('ageWindow') }); // open if btn is pressed
$("#metOpt").click(function() {strtBlackout('metWindow') }); // open if btn is pressed
$("#keyOpt").click(function() {strtBlackout('keyWindow') }); // open if btn is pressed
$("#allOpt").click(function() {strtBlackout('allWindow') }); // open if btn is pressed

$(".blackout").click(endBlackout); // close if click outside of popup
$(".closeBox").click(endBlackout); // close if close btn clicked

// Automatically trigger the pop-up after 10 seconds
//setTimeout( strtBlackout, 10000);
});

			document.getElementById('clear').onclick = clearCanvas;


function clearCanvas() {
  $('.patient').remove()
  $('.myCharts').remove()

  document.getElementById('merge').disabled = false

  window.my_config = null

  
  return false;
}
        
			 			$(function() {
            $('a#query').bind('click', function() {

                if               (inputValid() == true){
            $.getJSON('/_add_numbers', {
            keywords: $('input[name="keyword"]').val(),
            key_exclude: $('input[name="key_exclude"]').val(),
            age: $('input[name="age"]').val(),
            limit: $('input[name="limit"]').val(),
            uxlimit: $('input[name="uxlimit"]').val(),
            lxlimit: $('input[name="lxlimit"]').val(),
	    location: $('#location option:selected').val(),
            merge: document.getElementById('merge').checked,
            metabolites: $('input[name="metabolites"]').val(),
            values: $('input[name="values"]').val(),
            gender: $("#gender option:selected").val(),
            field: $("#field option:selected").val(),
            ID: $('input[name="ID"]').val(),
            windowed_SD_threshold: $('input[name="sdThreshold"]').val(),
            overlay: (document.getElementById('overlay').checked == false || (document.getElementById('overlay').checked == true && window.my_config == null))? 0:(window.my_config.results[window.my_config.names[0]].cols.length -1)
            }, function(data) {
            
            

			if (document.getElementById('overlay').checked == false || (document.getElementById('overlay').checked == true && window.my_config == null)){

							window.my_config = {metadata_array: data.metadata_array,
												sd_array: data.sd_array,
												results: data.result,
												names: data.names
												}
							
				            render_html(data.names)
            				drawChart(data.result);
			} else {

				if (window.my_config.sd_array != null)
					window.my_config['sd_array'] = window.my_config.sd_array.concat(data.sd_array)

				window.my_config['metadata_array'] = window.my_config.metadata_array.concat(data.metadata_array)
								console.log(data.metadata_array)
				console.log(window.my_config.metadata_array.concat(data.metadata_array))
				
				
				redraw_charts(data.result)
			
			}

			
            $(".patient").remove()
            
            });
            return false;
           } });
            });

$(document).ready(function () {

	setSize()

    $(window).bind('resize', function() {
		scrollControl()
        setSize()
    })

    $(window).scroll(function () {
    	scrollControl()
    })
        

});

/**
 * Convert an instance of google.visualization.DataTable to CSV
 * @param {google.visualization.DataTable} dataTable_arg DataTable to convert
 * @return {String} Converted CSV String
 */
function dataTableToCSV(dataTable_arg) {
    var dt_cols = dataTable_arg.getNumberOfColumns();
    var dt_rows = dataTable_arg.getNumberOfRows();
    
    var csv_cols = [];
    var csv_out;
    
    // Iterate columns
    for (var i=0; i<dt_cols; i++) {
        // Replace any commas in column labels
        csv_cols.push(dataTable_arg.getColumnLabel(i).replace(/,/g,""));
    }
    
    // Create column row of CSV
    csv_out = csv_cols.join(",")+"\r\n";
    
    // Iterate rows
    for (i=0; i<dt_rows; i++) {
        var raw_col = [];
        for (var j=0; j<dt_cols; j++) {
            // Replace any commas in row values
            raw_col.push(dataTable_arg.getFormattedValue(i, j, 'label').replace(/,/g,""));
        }
        // Add row to CSV text
        csv_out += raw_col.join(",")+"\r\n";
    }
 
    return csv_out;
}

/**
 * Convert an instance of google.visualization.DataTable to CSV
 * @param {google.visualization.DataTable} dataTable_arg DataTable to convert
 * @return {String} Converted CSV String
 */
function dataTableAndMetadataToCSV(dataTable_arg) {
    var dt_cols = dataTable_arg.getNumberOfColumns();
    var dt_rows = dataTable_arg.getNumberOfRows();
    
    var csv_cols = [];
    var csv_out;
    
    csv_cols.push('Patient ID')
    // Iterate columns
    for (var i=0; i<dt_cols; i++) {
        // Replace any commas in column labels
        csv_cols.push(dataTable_arg.getColumnLabel(i).replace(/,/g,""));
    }
    
    // Create column row of CSV
    csv_out = csv_cols.join(",")+"\r\n";
    
    // Iterate rows
    for (i=0; i<dt_rows; i++) {
        var raw_col = [];
        raw_col.push(window.my_config.metadata_array[i][0].ID)
        for (var j=0; j<dt_cols; j++) {
            // Replace any commas in row values
            raw_col.push(dataTable_arg.getFormattedValue(i, j, 'label').replace(/,/g,""));
        }
        //for (sd in window.sd_array[i])
        //raw_col.push(window.sd_array[])
        // Add row to CSV text
        csv_out += raw_col.join(",")+"\r\n";
    }
 
    return csv_out;
}

function downloadCSV (csv_out, name) {
            var blob = new Blob([csv_out], {type: 'text/csv;charset=utf-8'});
            var url  = window.URL || window.webkitURL;
            var link = document.createElementNS("http://www.w3.org/1999/xhtml", "a");
            link.href = url.createObjectURL(blob);
            link.download = name + ".csv"; 

            var event = document.createEvent("MouseEvents");
            event.initEvent("click", true, false);
            link.dispatchEvent(event); 
}


	function setSize(){
		var width = ($(window).width() / 2 )
		var height = $(window).height()
		$('#left').css({
		'width':width+20,

		})
		$('#right').css({
		'width':width-20,
		})
	}

	function scrollControl(){

        var scroll = $(this).scrollTop()? $(this).scrollTop():0
        var height = $('#sidebar').height() + 'px';
        var max_height = $(window).height()
        var width = $(window).width()/2
        var top_height = document.getElementById('top_header').offsetHeight

        if (scroll < $('#charts').offset().top) {

            $('#sidebar').css({
                'position': 'static',
                'top': '0',
                'max-height': max_height - (top_height-scroll),
            });

        } else {

            $('#sidebar').css({
                'position': 'fixed',
                'top': '0',
				'left': width + 20,
                'max-height': max_height,

            })
        }
	}

  function prepareList() {
  	for (patient in window.my_config.current_selection) {
  		$('#'+patient).find('li:has(ul)').unbind('click').click(function(event) {
		if(this == event.target) {
			$(this).toggleClass('expanded');
			$(this).children('ul').toggle('medium');
		}
		return false;
	}).addClass('collapsed').removeClass('expanded').children('ul').hide();
 
	//Hack to add links inside the cv
	$('#' + patient + 'a').unbind('click').click(function() {
		window.open($(this).attr('href'));
		return false;
	});

	}
};

            $(document).keyup(function(e) {
            if (e.keyCode == 13) { $('.query').click(); }     // enter
            if (e.keyCode == 27) {
             	            
            		for (c in window.my_config.charts){
		            	window.my_config.charts[c].setSelection()
		            		}
					}
					$(".patient").remove()  // esc
            });

            function render_html(names) {
            if (document.getElementById('overlay').checked != true){
            	$(".myCharts").remove()
            } else if ('charts' in window.my_config) {console.log("True")}
            
            for (name in names) {
            $("#charts").after("<div id = " + names[name] + " style='max-width: 700px; width: 100%; height: 400px; float: right;' class = 'myCharts'>")
                }
                }


                google.load("visualization", "1", {packages:["corechart"]});
                // google.setOnLoadCallback(drawChart);

            function drawChart(results) {
                // render and store DataTables in dictionary
                allChartData = {}
                for (result in results) {
                allChartData[result] = new google.visualization.DataTable(results[result])
                }

                charts = {}
                for (c in allChartData){
                var columns = allChartData[c].getNumberOfColumns()

                var options = {
                title: 'Age vs. ' + c,
                hAxis: {title: 'Age',            
                logScale: document.getElementById('scale').checked? true:false},
                vAxis: {title: c},

                legend: { position: 'top', maxLines : '5'},
                // maxLines not working properly? Only shows up to 2 lines?

                aggregationTarget: 'series',
                selectionMode: 'multiple',
                pointSize: 4,
                explorer: {},
                trendlines: document.getElementById('trendline').checked? { 0: {pointSize: 0, type: 'linear'} }: null,
                chartArea: columns > 2? {width: '70%', height: '70%'}:{width: '80%', height: '70%'},
                tooltip: {isHtml: true, trigger: 'none'},
                }

                charts[c] = new google.visualization.ScatterChart(document.getElementById(c));
                charts[c].draw(allChartData[c], options);
                }

                window.my_config['charts'] = charts;

                for (c in charts) {
                	google.visualization.events.addListener(charts[c], 'select', function() {
                	    showHideSeries()
                		update_sidebar()
                	 } )
                	
                	/*google.visualization.events.addListener(charts[c], 'onmouseover', sidebar_mouseover);
    				google.visualization.events.addListener(charts[c], 'onmouseout', sidebar_mouseout) */
                }
                };

				 /*function sidebar_mouseover() {
				 	
				 }*/

			function redraw_charts(results){
				var merged_results = window.my_config.results
				for (d in merged_results){
					var label = ''
					if (d in results){
						merged_results[d]['rows'] = merged_results[d]['rows'].concat(results[d].rows)
						label = results[d].cols[results[d].cols.length -1].label
						console.log(label)
						}
					merged_results[d]['cols'] = merged_results[d]['cols'].concat({"id": "", "label": label, "type": "number"})
				}
				console.log(merged_results)
				drawChart(merged_results)
			}

            function compare_unique_dict(a,b) {
                 var a_key = 0
                 var b_key = 0
                 for (c in a)
                    a_key = Math.round(a[c])
                 for (d in b)
                    b_key = Math.round(b[d])
                if (a_key < b_key)
                    return -1;
                if (a_key > b_key)
                    return 1;
                return 0;
}
				 

				function add_SD(r){
					var complete_list = ""
					
					var positive = []
					var negative = []					
					var zero = []
					
					var categories = [positive,negative,zero]

					//sort and order
					var ordered_sd = window.my_config.sd_array[r].sort(compare_unique_dict)

					for (m in ordered_sd){
						if (compare_unique_dict(ordered_sd[m],{'a':0}) == 0){

							zero.push(ordered_sd[m])
						}
						else if (compare_unique_dict(ordered_sd[m],{'a':0}) == 1){
							positive.unshift(ordered_sd[m])
						}
						else {
							negative.push(ordered_sd[m])
						}						
					}
					console.log(categories)
					var ent_list = "<div class='listContainer'><ul id='"+r+"' class='justify'>"

					//render the list
					for (c in categories){
                        var arrow = ""
                        if (c == 0){
                                arrow += "<img src='/img/up.png' alt='Raised' style='width:15px;height:15px'>"
                    }       else if (c == 1) {
                                arrow += "<img src='/img/down.png' alt='Lowered' style='width:15px;height:15px'>"
                    }

						if (categories[c].length > 0) {
							var elem = "<li>"

							for (met in categories[c][0])
								elem +="" + met + ": " +arrow+ Math.round(categories[c][0][met]) + " SD"
							
						
							if(categories[c].length > 1){
								elem += "<ul class='justify'>"
								for (i = 1; i < categories[c].length; i++){
									for (name in categories[c][i])
										elem +="<li>" + name +": " + arrow+ Math.round(categories[c][i][name]) + " SD </li>"
								}
								elem += "</ul>"
							}
						ent_list += elem +"</li>"
						}
					}
					ent_list += "</ul></div>"
					
					return ent_list

				}

	function showHideSeries () {

		for(chart in window.my_config.charts) {
		
		var data = new google.visualization.DataTable(window.my_config.results[chart])
        var sel = window.my_config.charts[chart].getSelection();
        var cols = []
        // if selection length is 0, we deselected an element
        if (sel.length > 0) {
            // if row is undefined, we clicked on the legend
            if (sel[0].row == null) {
                //cols += sel[0].column
                //console.log(cols)

				var view = new google.visualization.DataView(data)
				view.setColumns(sel[0].column)
				chart.draw(view)
                    
            }        	
        }
    }
}

                function update_sidebar(){

		            $(".patient").remove()

		            var patients = {}

		            for (c in window.my_config.charts){
		            	selection = window.my_config.charts[c].getSelection()
		            		for (i = 0; i < selection.length; i++){
		            			patient = selection[i].row
		            			if (selection[i].row in patients || selection[i].row == null){} else{
		            				patients[patient] = null
		            			}
		            		}
					}

					window.my_config['current_selection'] = patients

					for (r in patients){

						var i = ""

						for (m in window.my_config.metadata_array[r]) {
		            		for (n in window.my_config.metadata_array[r][m]) {
		            			if (window.my_config.metadata_array[r][m][n]) {
		            				i+= "<div class='title'>"
		            					+n+": </div><div class='content'>" 
		            					+ window.my_config.metadata_array[r][m][n] + "</div>"
		            				}
		            			
		            				
		            		}
		            	}
		            	if (window.my_config.sd_array != null){
		           			i+= "<div class='title'>SD for available metabolites:</div><div class='content'>" + add_SD(r) +"</div>"
							}

						$("#sidebar").append("<div id='"+window.my_config.metadata_array[r].id+"' class='patient'>"+i+"</div>")
								            	
		            }

		            if (window.my_config.sd_array != null)
						prepareList()
					//needed in case scroll bar results from overflow of
					setSize()
                }

                /*
				 * for (c in charts) {
				 * google.visualization.events.addListener(charts[c], 'select',
				 * select_rows(charts[c], charts)); } };
				 * 
				 * function select_rows (chart, charts){ alert("Selection!") var
				 * r = [{row: chart.getSelection()[0].row}]; for (c in charts){
				 * 
				 * charts[c].setSelection(r); } }
				 */

                /*
				 * for(i=0; i < document.FormName.elements.length; i++) {
				 * document.FormName.elements[i].disabled=true; }
				 */
        </script>
        
    </body>
</html>
